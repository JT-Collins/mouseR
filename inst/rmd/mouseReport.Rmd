---
title: "Mouse Work"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    highlight: kate
params: 
  data: "ExcelSheet"
  mouseNum: NULL
  groupNum: NULL
  exp_length: NULL    
editor_options: 
  chunk_output_type: console
---
```{r setup, include=FALSE}
## Global options
knitr::opts_chunk$set(cache = FALSE)
knitr::opts_chunk$set(fig.retina = 1)
knitr::opts_chunk$set(dev = "ragg_png")
knitr::opts_chunk$set(fig.align = 'center')
knitr::opts_chunk$set(error=TRUE)
knitr::opts_knit$set(root.dir = rstudioapi::getActiveProject())
```

```{r, echo=FALSE}
if(!require(pacman))install.packages("pacman")

pacman::p_load(
  'readxl', #
  'janitor', #
  'dplyr', #
  'labPlots', #
  'tidyr',
  #'gapminder',
  'ggplot2', #
  #'patchwork',
  #'ggalt',
  'ragg', #
  #'forcats',
  #'R.utils',
  #'png',
  #'grid',
  #'ggpubr',
  'scales',
  #'rstatix',
  'pander' #
)

labPlots::lab_fonts()
```

```{r, echo=FALSE}
# Excel Column names ------------------------------------------------------
# Generates a list of excel column names A -> ZZ

all <- expand.grid(LETTERS, LETTERS)
all <- all[order(all$Var1,all$Var2),]
excel_col <- c(LETTERS, do.call('paste0',all))
```


```{r, echo=FALSE}
# Check if folders exist and if not create them 

# check if sub directory exists 
if (!file.exists(paste0(rstudioapi::getActiveProject(),"/figures"))){
          
      # create a new sub directory inside
        # the main path
        dir.create(file.path(paste0(rstudioapi::getActiveProject(),"/figures")))
} 
        


# check if sub directory exists 
if (!file.exists(paste0(rstudioapi::getActiveProject(),"/report"))){
          
        # create a new sub directory inside
        # the main path
        dir.create(file.path(paste0(rstudioapi::getActiveProject(),"/report")))
} 
          

```



```{r, message=FALSE, echo=FALSE}
dat_file <- params$data



weights <- read_excel(dat_file,
                      sheet = "Mouse Weights",
                      range = paste0("A2:", excel_col[4+params$exp_length],(2 + params$mouseNum)))


clinical <- read_excel(dat_file,
                      sheet = "Clinical Score",
                      col_types = c("numeric", "text", "text", "text", "numeric")
                      )

cfu <- read_excel(dat_file,
                      sheet = "CFU",
                      range = paste0("A1:", excel_col[3+params$exp_length],(3 * params$mouseNum)))

surv <- read_excel(dat_file,
                   sheet = "Survival",
                   range = paste0("A1:F", (((params$exp_length + 1) * params$groupNum)+1))
                   )

```

Mouse report generated on `r Sys.Date()`.

## Mouse Weights

Our data is in wide format which is generally easier to view in Excel but not a good format for manipulating within R.

```{r, message=FALSE, warning=FALSE}
weights |>
    janitor::remove_empty() |># Drops columns/rows with only NA values
    select(-`Min Weight`) |> # For this we just want the daily weights
    pander()
```

We can easily pivot the data into the long format

```{r}
# Tidy and pivot into long form
cleanDF <- 
  weights |>
    janitor::remove_empty() |># Drops columns/rows with only NA values
    select(-`Min Weight`) |> # For this we just want the daily weights
    pivot_longer(cols = where(is.double), names_to = "Time", values_to = "g") |>
    mutate_at("Time", as.numeric) |>
    janitor::clean_names()

```

Look at the top of our new DF to ensure it looks good:

```{r}
pander(head(cleanDF))  
```



```{r}
raw_weight_plot <-
  cleanDF |>
  group_by(group, sex, time) |>
  ggplot(aes(x=time, y=g, group = mouse, colour = sex)) +
  geom_line(size = 1)+
  labs(title = "Weight Change by mouse", 
       caption = paste0("(Figure generated on ", Sys.Date(), ")")) +
  xlab("Time in days") +
  ylab("Weight (g)") +
  coord_cartesian(xlim = c(min(cleanDF$time), params$exp_length)) +
  facet_wrap(.~group, ncol = 2) + 
  lab_style() +
  NULL


```

### Raw mouse weights

The first thing to do is look at the raw mouse weights and just check that the data looks good i.e. no wild weight changes that would indicate a data entry error.

```{r, fig.fullwidth = TRUE}
raw_weight_plot
```

Figures will be saved to a `figures` folder in your working directory.

```{r, message=FALSE}
showtext::showtext_opts(dpi = 300)
ggsave(paste0(rstudioapi::getActiveProject(), "/figures/Weight_Change_by_mouse_", Sys.Date(), ".png"), device = ragg::agg_png,  res = 300, scaling = 1)
showtext::showtext_opts(dpi = 96)

```

### Percent change

Because all of the mice have different starting weights (especially if using male and female mice) we need to normalize what we are looking at. Here we will normalize our weights by day Zero - this is the day the mice receive a bacterial challenge.

```{r}
per_weight_DF <-
  cleanDF |>
  group_by(group, sex, mouse) |>
  mutate(first = g[time == 0]) |>
  mutate(pct_change = (g / first) * 100)


pander(head(per_weight_DF))
```  

```{r}  
per_weight <-
per_weight_DF |>  
  ggplot(aes(x=time, y=pct_change, group = mouse,  colour = sex)) +
  geom_hline(yintercept = 100, linetype = 3, size = 0.8, alpha = 0.3) +
  geom_vline(xintercept = 0, linetype = 3, size = 0.8, alpha = 0.3) +
  geom_hline(yintercept = 80, linetype = 3, size = 0.8, colour = "darkred", alpha = 0.5) +
  geom_line(size=1) +
  labs(title = "Percent Weight Change by mouse", 
      subtitle = "Weight from experiment start",
      caption = paste0("(Figure generated on ", Sys.Date(), ")")) +
  xlab("Time in days") +
  ylab("Percent weight") +
  scale_y_continuous(labels = function(x) paste0(x, "%")) + # Add percent symbol to your axis labels
  coord_cartesian(xlim = c(min(cleanDF$time), params$exp_length)) +
  facet_wrap(group~., nrow =2) + 
  lab_style() +
  NULL
```


```{r, fig.fullwidth = TRUE}

per_weight

```



```{r, message=FALSE}
showtext::showtext_opts(dpi = 300)
ggsave(paste0(rstudioapi::getActiveProject(), "/figures/Percent_Change_by_mouse_", Sys.Date(), ".png"), 
       device = ragg::agg_png,  
       res = 300, 
       scaling = 1)
showtext::showtext_opts(dpi = 96)

```


### Average weight change by group/sex

Because we want to know how our groups are effected overall we can plot the mean weights and standard deviation. First we need to calculate this and generate a new DF. We will add a mouse number column so we can clearly see if any mice have been lost due to disease.

```{r}
ave_weight_DF <- 
  per_weight_DF |>
  group_by(group, time) |>
  summarise(mean_pct_weight = mean(pct_change, na.rm = TRUE), # mean weight per group
            std_pct_weight = sd(pct_change, na.rm = TRUE),  # SD per group
            mouse_num = sum(!is.na(pct_change)),  # Count of number of mice at each timepoint
            .groups = "drop")
  
pander(ave_weight_DF)  
```  
  
Plot the new data.
  
```{r}
ave_weight <-
ave_weight_DF |>
  ggplot() +
  geom_hline(yintercept = 100, linetype = 3, size = 0.8, alpha = 0.3) +
  geom_vline(xintercept = 0, linetype = 3, size = 0.8, alpha = 0.3) +
  geom_ribbon(aes(x = time, ymin = mean_pct_weight - std_pct_weight, ymax = mean_pct_weight + std_pct_weight,
                  group = group), alpha = 0.15) +
  geom_line(aes(x=time, y=mean_pct_weight , group = group), size=1) +
  geom_text(aes(x=time, y=(max(mean_pct_weight) + 10), label = mouse_num)) +
  labs(title = "Mean Percent Weight Change With SD", 
       subtitle = "Weight from experiment start",
       caption = paste0("(Figure generated on ", Sys.Date(), ")")) +
  xlab("Time in days") +
  ylab("Percent weight") +
  coord_cartesian(xlim = c(min(cleanDF$time), params$exp_length)) +
  facet_wrap(.~group, nrow =2) + 
  lab_style() +
  NULL

ave_weight

```

```{r}
showtext::showtext_opts(dpi = 300)
ggsave(paste0(rstudioapi::getActiveProject(), "/figures/Ave_Percent_Change_by_mouse_", Sys.Date(), ".png"), 
       device = ragg::agg_png,  
       res = 300, 
       scaling = 1)
showtext::showtext_opts(dpi = 96)
```

## Clinical Score

The clinical score is based upon five categories scored 0-3 with 3 being the most severe: 

```{r table2, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
tabl <- tribble(
~Category, ~"0",  ~"1", ~"2", ~"3",
  "Activity", "Normal",  "Alert/Slow moving", "Lethargic/Shaky", "Inactive unless prodded",
  "Posture", "Normal",  "Back slanted", "Hunched", "Hunched/Nose down",
  "Coat", "Normal", "Piloerection", "Rough skin", "Very ruffled/Puff/Ungroomed",
"Diarrhea", "Normal", "Soft stool/Discoloured (yellowish)", "Wet stained tail mucous +/- blood", "liquid/no stool (ileus)", "Eyes/Nose", "Normal", "Squinted 1/2 closed", "Squinted/Discharge", "Closed/Discharge"
)

pander(tabl) # output the table in a format good for HTML/PDF/docx conversion
```

```{r}
# clean up dataframe

clinical <-
  clinical |>
  janitor::clean_names() |>
  na.omit()# Drops rows with NA values
  
pander(head(clinical))
```

As before we first clean up our DF

```{r, fig.fullwidth = TRUE}
clinical |>
  group_by(group, mouse, day) |>
  summarise(total_score = sum(score)) |>
  ggplot() +
  geom_line(aes(x=day, y=total_score, colour=mouse)) +
  scale_x_continuous(breaks= pretty_breaks()) +
  labs(title = "Clinical Score", 
       subtitle = NULL,
       caption = paste0("(Figure generated on ", Sys.Date(), ")")) +
  xlab("Time in days") +
  ylab("Clinical Score") +
  facet_wrap(.~group, nrow = 2) + 
  lab_style() + 
  NULL


```

```{r,fig.fullwidth = TRUE}
clinical |>
  ggplot() +
  geom_bar(aes(x=day, y=score, fill=category), stat = "identity") +
  facet_wrap(.~mouse) + 
  labs(title = "Clinical Score", 
       subtitle = NULL,
       caption = paste0("(Figure generated on ", Sys.Date(), ")")) +
  xlab("Time in days") +
  ylab("Clinical Scores") +
  lab_style() +
  theme(legend.position = "bottom") +
  NULL


```

## CFUs

We want to know how much of our bacteria are present - usually in stool but also in tissues if we expect translocation.

